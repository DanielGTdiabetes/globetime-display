#!/usr/bin/env bash
set -euo pipefail
LOG=/tmp/backend-launch.log
exec >>"$LOG" 2>&1
echo "[backend] $(date -Is) start"

APP_ROOT="/opt/pantalla-reloj"
BACKEND_DIR="${APP_ROOT}/backend"
PY="$BACKEND_DIR/.venv/bin/python"

if [[ ! -d "$BACKEND_DIR" ]]; then
  echo "[backend] ERROR: BACKEND_DIR no existe: $BACKEND_DIR" >&2
  exit 2
fi

if [[ ! -x "$PY" ]]; then
  echo "[backend] ERROR: venv no existe: $PY" >&2
  exit 2
fi

cd "$APP_ROOT"
export PYTHONPATH="$APP_ROOT"

"$PY" - <<'PYCODE'
import importlib, sys
try:
    m = importlib.import_module("backend.main")
    print("[backend] import OK:", m.__name__)
except Exception as e:
    print("[backend] import FAIL:", repr(e))
    sys.exit(3)
PYCODE

exec "$PY" -m uvicorn backend.main:app \
  --host 127.0.0.1 --port 8081 \
  --proxy-headers --timeout-keep-alive 30
